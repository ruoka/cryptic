name: C/C++ CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Cache LLVM 20 + libc++
        id: cache-llvm
        uses: actions/cache@v4
        with:
          path: |
            /usr/lib/llvm-20
            /usr/bin/clang-20
            /usr/bin/clang++-20
            /usr/bin/lld-20
            /usr/bin/lldb-20
          key: llvm-20-ubuntu-${{ runner.arch }}-2025-v4
          restore-keys: |
            llvm-20-ubuntu-${{ runner.arch }}-
            llvm-20-ubuntu-
            llvm-20-

      - name: Install LLVM toolchain
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget gnupg ca-certificates lsb-release software-properties-common
          wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo gpg --dearmor -o /usr/share/keyrings/apt-llvm.gpg
          echo "deb [signed-by=/usr/share/keyrings/apt-llvm.gpg] https://apt.llvm.org/$(lsb_release -cs)/ llvm-toolchain-$(lsb_release -cs)-20 main" | sudo tee /etc/apt/sources.list.d/apt-llvm.org.list > /dev/null
          sudo apt-get update -y
          sudo apt-get install -y libc++-20-dev libc++abi-20-dev clang-20 lldb-20 lld-20 libssl-dev
          sudo update-alternatives --install /usr/bin/clang   clang   /usr/bin/clang-20   100
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-20 100
          sudo update-alternatives --install /usr/bin/lld     lld     /usr/bin/lld-20     100

      - name: Verify std.cppm location
        run: |
          if [ -f /usr/lib/llvm-20/share/libc++/v1/std.cppm ]; then
            echo "std.cppm found at /usr/lib/llvm-20/share/libc++/v1/std.cppm"
          else
            echo "Warning: std.cppm not found at expected location"
            find /usr/lib/llvm-20 -name "std.cppm" 2>/dev/null || echo "std.cppm not found anywhere"
          fi

      - name: Build project
        run: ./tools/CB.sh debug build

      - name: Run tests
        run: ./tools/CB.sh debug test

      - name: Build benchmark (release)
        # The benchmark lives under tests/, so make sure test targets are built in release mode.
        # --build-tests builds test targets but doesn't run them.
        run: ./tools/CB.sh release build --build-tests

      - name: Run benchmark (release, timed)
        run: |
          set -euo pipefail
          test -x ./build-linux-release/bin/benchmark
          # Ensure LLVM libc++ runtime is discoverable at runtime (Ubuntu runners don't always have it on the default loader path).
          export LD_LIBRARY_PATH="/usr/lib/llvm-20/lib:${LD_LIBRARY_PATH:-}"
          timeout 120s ./build-linux-release/bin/benchmark || {
            echo "benchmark failed; diagnostics:"
            ls -la ./build-linux-release/bin || true
            ldd ./build-linux-release/bin/benchmark || true
            exit 1
          }

  static-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Setup LLVM + analysis tools
        uses: ./.github/actions/setup-llvm
        with:
          packages: "libc++-20-dev libc++abi-20-dev clang-20 lld-20 lldb-20 jq clang-tools-20 clang-tidy-20 cppcheck libssl-dev"

      - name: Run clang-tidy (non-blocking)
        run: |
          set -euo pipefail
          find cryptic -name "*.c++m" -o -name "*.c++" | head -20 | while read -r f; do
            echo "Analyzing $f"
            clang-tidy-20 "$f" -- -std=c++23 -I/usr/lib/llvm-20/include/c++/v1 2>/dev/null || true
          done

      - name: Run cppcheck (non-blocking)
        run: |
          cppcheck --enable=all --std=c++23 --language=c++ \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --inline-suppr \
            --quiet \
            cryptic/ tools/ tests/ 2>/dev/null || true

  submodule-check:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Check submodule status + clean tree
        run: |
          set -euo pipefail
          echo "=== Submodule Status ==="
          git submodule status || echo "No submodules"
          echo ""
          echo "=== Checking for uncommitted changes ==="
          if git status --porcelain | grep -q .; then
            echo "✗ Uncommitted changes found"
            git status --porcelain
            exit 1
          else
            echo "✓ Repo is clean"
          fi
